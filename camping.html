<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Modifier ma cagnotte</title>
<style>
body { font-family: Arial; text-align:center; margin-top:50px; }
#total_personnel { font-size:30px; margin:10px; color:blue; }
#last { font-size:20px; color:green; }
</style>
</head>
<body>

<h1 id="titre"></h1>

<input type="number" id="montant" placeholder="Ajouter un montant">
<button id="btnAjouter">Ajouter</button>

<div id="last">Dernière valeur ajoutée : 0</div>
<div id="total_personnel">Total de ce camping : 0</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBnTkiUSRgVlD0sLTuV0YV92LWkPWBQAbA",
  authDomain: "compteur-million-2.firebaseapp.com",
  databaseURL: "https://compteur-million-2-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "compteur-million-2",
  storageBucket: "compteur-million-2.firebasestorage.app",
  messagingSenderId: "226299332536",
  appId: "1:226299332536:web:4d79be3a4ed0b2ba50714d"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Récupérer l'ID camping depuis l'URL
const params = new URLSearchParams(window.location.search);
const campingId = params.get('id');
if(!campingId){
  alert("ID camping manquant !");
  throw new Error("ID camping manquant !");
}

document.getElementById("titre").innerText = "Modifier la cagnotte - " + campingId;

// Référence Firebase pour ce camping
const campingRef = database.ref('campings/' + campingId);

// Lire le total initial et en temps réel
campingRef.on('value', snapshot => {
  const total_camping = snapshot.val() || 0;
  document.getElementById('total_personnel').innerText = "Total de ce camping : " + total_camping;
});

// Ajouter un montant
document.getElementById("btnAjouter").addEventListener("click", () => {
  const montant = parseInt(document.getElementById('montant').value);
  if(isNaN(montant) || montant <= 0){
    alert("Veuillez entrer un montant valide !");
    return;
  }

  // Transaction sécurisée pour créer ou mettre à jour la valeur
  campingRef.transaction(current => {
    if(current === null) return montant; // si la clé n’existe pas encore
    return current + montant;
  }, (err, committed, snapshot) => {
    if(err) console.error("Erreur Firebase :", err);
    else if(committed){
      document.getElementById('last').innerText = "Dernière valeur ajoutée : " + montant;
      document.getElementById('total_personnel').innerText = "Total de ce camping : " + snapshot.val();
      document.getElementById('montant').value = "";
    }
  });
});
</script>

</body>
</html>
